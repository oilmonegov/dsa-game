#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# prepare-commit-msg hook
# $1 = path to file containing commit message
# $2 = source of commit message (message, template, merge, squash, commit)
# $3 = commit SHA (if amending)

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2

# Skip if this is a merge commit or already has a message
if [ "$COMMIT_SOURCE" = "merge" ]; then
  exit 0
fi

# Get the current branch name
BRANCH_NAME=$(git symbolic-ref --short HEAD 2>/dev/null)

# Extract issue number from branch name if it follows pattern: feature/123-description or fix/PROJ-123-description
ISSUE_NUMBER=$(echo "$BRANCH_NAME" | grep -oE '([A-Z]+-)?[0-9]+' | head -1)

# If we found an issue number and the commit message doesn't already reference it
if [ -n "$ISSUE_NUMBER" ]; then
  COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
  if ! echo "$COMMIT_MSG" | grep -qE "#$ISSUE_NUMBER|$ISSUE_NUMBER"; then
    # Only add for non-template commits where user is typing a message
    if [ "$COMMIT_SOURCE" = "message" ] || [ -z "$COMMIT_SOURCE" ]; then
      # Don't modify, just remind the user
      echo ""
      echo "ðŸ’¡ Tip: Consider referencing issue #$ISSUE_NUMBER in your commit message"
    fi
  fi
fi
